{% extends "base.html" %}

{% block title %}Admin - Einstellungen{% endblock %}

{% block content %}
<div class="admin-page">
    <!-- Header -->
    <header class="header">
        <h1>‚öôÔ∏è Einstellungen</h1>
    </header>
    
    <!-- System Status -->
    <section class="admin-section">
        <h2>üìä System Status</h2>
        <div class="status-grid">
            <div class="status-card">
                <div class="status-icon">üì∑</div>
                <div class="status-info">
                    <h3>Kamera</h3>
                    <p class="status-value {% if camera_connected %}status-ok{% else %}status-error{% endif %}">
                        {% if camera_connected %}‚úì Verbunden{% else %}‚úó Nicht verbunden{% endif %}
                    </p>
                </div>
                <button class="btn btn-small" onclick="testCamera()">Test</button>
            </div>
            
            <div class="status-card">
                <div class="status-icon">üñºÔ∏è</div>
                <div class="status-info">
                    <h3>Fotos</h3>
                    <p class="status-value">{{ photo_count }} gespeichert</p>
                </div>
                <button class="btn btn-small" onclick="openGallery()">Anzeigen</button>
            </div>
            
            <div class="status-card">
                <div class="status-icon">üíæ</div>
                <div class="status-info">
                    <h3>Speicher</h3>
                    <p class="status-value" id="storage-info">Wird geladen...</p>
                </div>
                <button class="btn btn-small" onclick="checkStorage()">Pr√ºfen</button>
            </div>
        </div>
    </section>
    
    <!-- Grundkonfiguration -->
    <section class="admin-section">
        <h2>‚öôÔ∏è Grundkonfiguration</h2>
        <div class="settings-form">
            <div class="form-row">
                <div class="form-group">
                    <label>Countdown aktiviert:</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="countdown-enabled" 
                               {% if config.countdown_enabled %}checked{% endif %}
                               onchange="updateConfig('countdown_enabled', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label>Countdown Dauer (Sekunden):</label>
                    <input type="number" id="countdown-duration" 
                           value="{{ config.countdown_duration }}" 
                           min="1" max="10"
                           onchange="updateConfig('countdown_duration', parseInt(this.value))">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Foto-Qualit√§t:</label>
                    <select id="photo-quality" onchange="updateConfig('photo_quality', this.value)">
                        <option value="Fine" {% if config.photo_quality == 'Fine' %}selected{% endif %}>Fein</option>
                        <option value="Normal" {% if config.photo_quality == 'Normal' %}selected{% endif %}>Normal</option>
                        <option value="Basic" {% if config.photo_quality == 'Basic' %}selected{% endif %}>Standard</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Kamera Modell:</label>
                    <input type="text" id="camera-model" 
                           value="{{ config.camera_model }}"
                           onchange="updateConfig('camera_model', this.value)">
                </div>
            </div>
        </div>
    </section>

    <!-- Overlay Konfiguration -->
    <section class="admin-section">
        <h2>üé® Overlay & Branding</h2>
        <div class="settings-form">
            <div class="form-group">
                <label class="toggle-switch">
                    <input type="checkbox" id="overlay-enabled-config" 
                           {% if config.overlay.enabled %}checked{% endif %}
                           onchange="updateConfig('overlay.enabled', this.checked)">
                    <span class="slider"></span>
                </label>
                <span>Overlays aktivieren</span>
            </div>
            
            <div class="form-group">
                <label class="toggle-switch">
                    <input type="checkbox" id="text-overlay-enabled" 
                           {% if config.overlay.text_enabled %}checked{% endif %}
                           onchange="updateConfig('overlay.text_enabled', this.checked)">
                    <span class="slider"></span>
                </label>
                <span>Text-Overlay aktivieren</span>
            </div>
            
            <div class="form-group">
                <label>Overlay Text:</label>
                <input type="text" id="overlay-text-config" 
                       value="{{ config.overlay.text_content }}"
                       placeholder="z.B. Fotobox Event 2025"
                       onchange="updateConfig('overlay.text_content', this.value)">
                <small>Verwende {date}, {time}, {datetime} f√ºr automatische Werte</small>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Text-Position:</label>
                    <select id="text-position" onchange="updateConfig('overlay.text_position', this.value)">
                        <option value="top-left" {% if config.overlay.text_position == 'top-left' %}selected{% endif %}>Oben Links</option>
                        <option value="top-center" {% if config.overlay.text_position == 'top-center' %}selected{% endif %}>Oben Mitte</option>
                        <option value="top-right" {% if config.overlay.text_position == 'top-right' %}selected{% endif %}>Oben Rechts</option>
                        <option value="bottom-left" {% if config.overlay.text_position == 'bottom-left' %}selected{% endif %}>Unten Links</option>
                        <option value="bottom-center" {% if config.overlay.text_position == 'bottom-center' %}selected{% endif %}>Unten Mitte</option>
                        <option value="bottom-right" {% if config.overlay.text_position == 'bottom-right' %}selected{% endif %}>Unten Rechts</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Schriftgr√∂√üe:</label>
                    <input type="number" id="text-font-size" 
                           value="{{ config.overlay.text_font_size }}"
                           min="12" max="72"
                           onchange="updateConfig('overlay.text_font_size', parseInt(this.value))">
                </div>
            </div>
        </div>
    </section>

    <!-- Druck Konfiguration -->
    <section class="admin-section">
        <h2>ÔøΩÔ∏è Druck-Einstellungen</h2>
        <div class="settings-form">
            <div class="form-group">
                <label class="toggle-switch">
                    <input type="checkbox" id="printing-enabled-config" 
                           {% if config.printing.enabled %}checked{% endif %}
                           onchange="updateConfig('printing.enabled', this.checked)">
                    <span class="slider"></span>
                </label>
                <span>Drucken aktivieren</span>
            </div>
            
            <div class="form-group">
                <label class="toggle-switch">
                    <input type="checkbox" id="auto-print-config" 
                           {% if config.printing.auto_print %}checked{% endif %}
                           onchange="updateConfig('printing.auto_print', this.checked)">
                    <span class="slider"></span>
                </label>
                <span>Automatisch drucken nach Foto</span>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Drucker Name:</label>
                    <input type="text" id="printer-name-config" 
                           value="{{ config.printing.printer_name }}"
                           placeholder="z.B. Canon_SELPHY_CP1300"
                           onchange="updateConfig('printing.printer_name', this.value)">
                </div>
                
                <div class="form-group">
                    <label>Papiergr√∂√üe:</label>
                    <select id="paper-size" onchange="updateConfig('printing.paper_size', this.value)">
                        <option value="10x15cm" {% if config.printing.paper_size == '10x15cm' %}selected{% endif %}>10x15cm</option>
                        <option value="A4" {% if config.printing.paper_size == 'A4' %}selected{% endif %}>A4</option>
                        <option value="A6" {% if config.printing.paper_size == 'A6' %}selected{% endif %}>A6</option>
                    </select>
                </div>
            </div>
        </div>
    </section>

    <!-- Upload Konfiguration -->
    <section class="admin-section">
        <h2>‚òÅÔ∏è Upload-Einstellungen</h2>
        <div class="settings-form">
            <div class="form-group">
                <label class="toggle-switch">
                    <input type="checkbox" id="upload-enabled-config" 
                           {% if config.upload.enabled %}checked{% endif %}
                           onchange="updateConfig('upload.enabled', this.checked)">
                    <span class="slider"></span>
                </label>
                <span>Upload aktivieren</span>
            </div>
            
            <div class="form-group">
                <label class="toggle-switch">
                    <input type="checkbox" id="auto-upload-config" 
                           {% if config.upload.auto_upload %}checked{% endif %}
                           onchange="updateConfig('upload.auto_upload', this.checked)">
                    <span class="slider"></span>
                </label>
                <span>Automatisch uploaden nach Foto</span>
            </div>
            
            <div class="form-group">
                <label>Upload-Methode:</label>
                <select id="upload-method-config" onchange="updateConfig('upload.upload_method', this.value)">
                    <option value="http" {% if config.upload.upload_method == 'http' %}selected{% endif %}>HTTP/HTTPS</option>
                    <option value="sftp" {% if config.upload.upload_method == 'sftp' %}selected{% endif %}>SFTP</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>HTTP Endpoint:</label>
                <input type="url" id="http-endpoint" 
                       value="{{ config.upload.http_endpoint }}"
                       placeholder="https://example.com/upload"
                       onchange="updateConfig('upload.http_endpoint', this.value)">
            </div>
        </div>
    </section>

    <!-- Kamera Einstellungen -->
    <section class="admin-section">
        <h2>üì∑ Kamera Status</h2>
        <div class="settings-form">
            <div class="form-group">
                <label>Kamera Status:</label>
                <div class="status-display" id="camera-status">
                    {% if camera_connected %}
                        <span class="status-ok">‚úì {{ config.camera_model }} erkannt</span>
                    {% else %}
                        <span class="status-error">‚úó Keine Kamera gefunden</span>
                    {% endif %}
                </div>
                <button class="btn btn-secondary" onclick="refreshCameraStatus()">
                    üîÑ Status aktualisieren
                </button>
            </div>
        </div>
    </section>
    
    <!-- Phase 2 Features -->
    <section class="admin-section">
        <h2>üöÄ Erweiterte Features (Phase 2)</h2>
        
        <!-- Overlay-Einstellungen -->
        <div class="feature-section">
            <h3>üé® Overlay & Branding</h3>
            <div class="feature-controls">
                <div class="toggle-group">
                    <label class="toggle-switch">
                        <input type="checkbox" id="overlay-enabled" onchange="toggleOverlay()">
                        <span class="slider"></span>
                    </label>
                    <span>Overlays aktivieren</span>
                </div>
                
                <div class="overlay-options" id="overlay-options" style="display: none;">
                    <div class="form-group">
                        <label>Text-Overlay:</label>
                        <input type="text" id="overlay-text" placeholder="z.B. Fotobox {date}" 
                               onchange="updateOverlayText()">
                        <small>Verwende {date}, {time}, {datetime} f√ºr automatische Werte</small>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="uploadLogo()">Logo hochladen</button>
                        <button class="btn btn-secondary" onclick="testOverlay()">Overlay testen</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Druck-Einstellungen -->
        <div class="feature-section">
            <h3>üñ®Ô∏è Automatisches Drucken</h3>
            <div class="feature-controls">
                <div class="toggle-group">
                    <label class="toggle-switch">
                        <input type="checkbox" id="print-enabled" onchange="togglePrint()">
                        <span class="slider"></span>
                    </label>
                    <span>Drucken aktivieren</span>
                </div>
                
                <div class="print-options" id="print-options" style="display: none;">
                    <div class="form-group">
                        <label>Drucker:</label>
                        <select id="printer-select" onchange="updatePrinter()">
                            <option value="">Drucker w√§hlen...</option>
                        </select>
                        <button class="btn btn-small" onclick="refreshPrinters()">üîÑ</button>
                    </div>
                    
                    <div class="form-group">
                        <label class="toggle-switch">
                            <input type="checkbox" id="auto-print" onchange="toggleAutoPrint()">
                            <span class="slider"></span>
                        </label>
                        <span>Automatisch drucken nach Foto</span>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="testPrinter()">Drucker testen</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Upload-Einstellungen -->
        <div class="feature-section">
            <h3>‚òÅÔ∏è Server Upload</h3>
            <div class="feature-controls">
                <div class="toggle-group">
                    <label class="toggle-switch">
                        <input type="checkbox" id="upload-enabled" onchange="toggleUpload()">
                        <span class="slider"></span>
                    </label>
                    <span>Upload aktivieren</span>
                </div>
                
                <div class="upload-options" id="upload-options" style="display: none;">
                    <div class="form-group">
                        <label>Upload-Methode:</label>
                        <select id="upload-method" onchange="updateUploadMethod()">
                            <option value="http">HTTP POST</option>
                            <option value="sftp">SFTP</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="http-config">
                        <label>HTTP Endpoint:</label>
                        <input type="url" id="http-endpoint" placeholder="https://server.com/upload" 
                               onchange="updateHttpEndpoint()">
                    </div>
                    
                    <div class="form-group">
                        <label class="toggle-switch">
                            <input type="checkbox" id="auto-upload" onchange="toggleAutoUpload()">
                            <span class="slider"></span>
                        </label>
                        <span>Automatisch hochladen nach Foto</span>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="testUpload()">Verbindung testen</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Phase 3: Kiosk & Deployment -->
        <div class="feature-section">
            <h3>üñ•Ô∏è Kiosk & Deployment</h3>
            <div class="feature-controls">
                <div class="feature-card">
                    <h4>Kiosk-Modus</h4>
                    <div class="form-group">
                        <label class="toggle-switch">
                            <input type="checkbox" id="kiosk-enabled" onchange="toggleKioskMode()">
                            <span class="slider"></span>
                        </label>
                        <span>Kiosk-Modus aktivieren</span>
                        <small>Startet die App automatisch im Vollbild nach Neustart</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="toggle-switch">
                            <input type="checkbox" id="autostart-enabled" onchange="toggleAutostart()">
                            <span class="slider"></span>
                        </label>
                        <span>Autostart aktivieren</span>
                        <small>Startet den Fotobox-Service automatisch beim Booten</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Bildschirm-Timeout (Minuten):</label>
                        <input type="number" id="screen-timeout" min="0" max="60" value="10" 
                               onchange="updateScreenTimeout()">
                        <small>0 = Bildschirm nie ausschalten</small>
                    </div>
                </div>
                
                <div class="feature-card">
                    <h4>Deployment & Backup</h4>
                    <div class="form-group">
                        <label class="toggle-switch">
                            <input type="checkbox" id="backup-enabled" onchange="toggleBackup()">
                            <span class="slider"></span>
                        </label>
                        <span>Automatisches Backup</span>
                        <small>Erstellt t√§glich um 2:00 Uhr ein Backup</small>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="createBackup()">
                            üíæ Backup jetzt erstellen
                        </button>
                        <button class="btn btn-secondary" onclick="exportConfig()">
                            üìÑ Konfiguration exportieren
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label>Konfiguration importieren:</label>
                        <input type="file" id="config-import" accept=".json" onchange="importConfig(this)">
                    </div>
                </div>
                
                <div class="feature-card">
                    <h4>System-Steuerung</h4>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="restartSystem()">
                            üîÑ System neustarten
                        </button>
                        <button class="btn btn-secondary" onclick="shutdownSystem()">
                            ‚èª System herunterfahren
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-warning" onclick="resetToDefaults()">
                            üîÑ Auf Standardwerte zur√ºcksetzen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- System Aktionen -->
    <section class="admin-section">
        <h2>üîß System Aktionen</h2>
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="restartApp()">
                üîÑ App neu starten
            </button>
            <button class="btn btn-secondary" onclick="checkUpdates()">
                üì¶ Updates pr√ºfen
            </button>
            <button class="btn btn-warning" onclick="clearCache()">
                üßπ Cache leeren
            </button>
        </div>
    </section>
    
    <!-- Quick Access Features -->
    <section class="admin-section">
        <h2>üöÄ Erweiterte Features</h2>
        <div class="feature-grid">
            <a href="{{ url_for('features') }}" class="feature-card">
                <div class="feature-icon">‚è±Ô∏è</div>
                <div class="feature-info">
                    <h3>Countdown & Features</h3>
                    <p>Erweiterte Funktionen konfigurieren</p>
                </div>
                <div class="feature-badge">Phase 4</div>
            </a>
        </div>
    </section>

    <!-- Navigation -->
    <nav class="bottom-nav">
        <a href="{{ url_for('index') }}" class="nav-item">
            <span class="nav-icon">üì∑</span>
            <span class="nav-text">Foto</span>
        </a>
        <a href="{{ url_for('gallery') }}" class="nav-item">
            <span class="nav-icon">üñºÔ∏è</span>
            <span class="nav-text">Galerie</span>
        </a>
        <a href="{{ url_for('admin') }}" class="nav-item active">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span class="nav-text">Einstellungen</span>
        </a>
        <a href="{{ url_for('features') }}" class="nav-item">
            <span class="nav-icon">üöÄ</span>
            <span class="nav-text">Features</span>
        </a>
    </nav>
</div>
{% endblock %}

{% block scripts %}
<script>
// Konfiguration aktualisieren
function updateConfig(key, value) {
    console.log(`Aktualisiere ${key} = ${value}`);
    
    const config = {};
    
    // Handle nested keys like 'overlay.enabled'
    if (key.includes('.')) {
        const keys = key.split('.');
        let current = config;
        for (let i = 0; i < keys.length - 1; i++) {
            current[keys[i]] = current[keys[i]] || {};
            current = current[keys[i]];
        }
        current[keys[keys.length - 1]] = value;
    } else {
        config[key] = value;
    }
    
    fetch('/api/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úì Konfiguration gespeichert', 'success');
        } else {
            showNotification('‚úó Fehler beim Speichern: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showNotification('Fehler beim Speichern: ' + error.message, 'error');
    });
}

// Kamera testen
function testCamera() {
    showLoading();
    
    fetch('/api/test_camera')
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showNotification('‚úì Kamera Test erfolgreich', 'success');
                console.log('Kamera Info:', data.summary);
            } else {
                showNotification('‚úó Kamera Test fehlgeschlagen: ' + data.error, 'error');
            }
        })
        .catch(error => {
            hideLoading();
            showNotification('Fehler beim Kamera Test: ' + error.message, 'error');
        });
}

// Kamera Status aktualisieren
function refreshCameraStatus() {
    fetch('/api/camera_status')
        .then(response => response.json())
        .then(data => {
            const statusElement = document.getElementById('camera-status');
            if (data.connected) {
                statusElement.innerHTML = '<span class="status-ok">‚úì ' + data.message + '</span>';
            } else {
                statusElement.innerHTML = '<span class="status-error">‚úó ' + data.message + '</span>';
            }
        })
        .catch(error => {
            showNotification('Fehler beim Status Update: ' + error.message, 'error');
        });
}

// Galerie √∂ffnen
function openGallery() {
    window.location.href = '{{ url_for("gallery") }}';
}

// Speicher pr√ºfen
function checkStorage() {
    const storageInfo = document.getElementById('storage-info');
    // Placeholder - in echter Implementierung w√ºrde hier der Speicher gepr√ºft
    storageInfo.textContent = 'Ausreichend verf√ºgbar';
    showNotification('üíæ Speicher Status aktualisiert', 'info');
}

// System Aktionen (Platzhalter)
function restartApp() {
    if (confirm('App wirklich neu starten?')) {
        showNotification('üîÑ Neustart wird implementiert...', 'info');
    }
}

function checkUpdates() {
    showNotification('üì¶ Update-Funktion wird in Phase 3 implementiert', 'info');
}

function clearCache() {
    showNotification('üßπ Cache-Funktion wird implementiert...', 'info');
}

// Phase 2 JavaScript-Funktionen

// Overlay-Funktionen
function toggleOverlay() {
    const enabled = document.getElementById('overlay-enabled').checked;
    document.getElementById('overlay-options').style.display = enabled ? 'block' : 'none';
    updateConfig('overlay.enabled', enabled);
}

function updateOverlayText() {
    const text = document.getElementById('overlay-text').value;
    updateConfig('overlay.text_content', text);
    updateConfig('overlay.text_enabled', text.length > 0);
}

function uploadLogo() {
    showNotification('üìÅ Logo-Upload wird in Phase 3 implementiert', 'info');
}

function testOverlay() {
    showNotification('üé® Overlay-Test wird implementiert', 'info');
}

// Druck-Funktionen
function togglePrint() {
    const enabled = document.getElementById('print-enabled').checked;
    document.getElementById('print-options').style.display = enabled ? 'block' : 'none';
    updateConfig('printing.enabled', enabled);
    
    if (enabled) {
        refreshPrinters();
    }
}

function toggleAutoPrint() {
    const enabled = document.getElementById('auto-print').checked;
    updateConfig('printing.auto_print', enabled);
}

function updatePrinter() {
    const printerName = document.getElementById('printer-select').value;
    updateConfig('printing.printer_name', printerName);
}

function refreshPrinters() {
    fetch('/api/printers')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('printer-select');
            select.innerHTML = '<option value="">Drucker w√§hlen...</option>';
            
            if (data.success && data.printers) {
                data.printers.forEach(printer => {
                    const option = document.createElement('option');
                    option.value = printer.name;
                    option.textContent = `${printer.name} (${printer.status})`;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            showNotification('Fehler beim Laden der Drucker: ' + error.message, 'error');
        });
}

function testPrinter() {
    showLoading();
    
    fetch('/api/test_printer', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showNotification('‚úì Drucker-Test erfolgreich', 'success');
            } else {
                showNotification('‚úó Drucker-Test fehlgeschlagen: ' + data.message, 'error');
            }
        })
        .catch(error => {
            hideLoading();
            showNotification('Fehler beim Drucker-Test: ' + error.message, 'error');
        });
}

// Upload-Funktionen
function toggleUpload() {
    const enabled = document.getElementById('upload-enabled').checked;
    document.getElementById('upload-options').style.display = enabled ? 'block' : 'none';
    updateConfig('upload.enabled', enabled);
}

function toggleAutoUpload() {
    const enabled = document.getElementById('auto-upload').checked;
    updateConfig('upload.auto_upload', enabled);
}

function updateUploadMethod() {
    const method = document.getElementById('upload-method').value;
    updateConfig('upload.upload_method', method);
    
    // Zeige/verstecke entsprechende Konfiguration
    document.getElementById('http-config').style.display = 
        method === 'http' ? 'block' : 'none';
}

function updateHttpEndpoint() {
    const endpoint = document.getElementById('http-endpoint').value;
    updateConfig('upload.http_endpoint', endpoint);
}

function testUpload() {
    showLoading();
    
    fetch('/api/test_upload', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showNotification('‚úì Upload-Test erfolgreich', 'success');
            } else {
                showNotification('‚úó Upload-Test fehlgeschlagen: ' + data.message, 'error');
            }
        })
        .catch(error => {
            hideLoading();
            showNotification('Fehler beim Upload-Test: ' + error.message, 'error');
        });
}

// Konfiguration aktualisieren
function updateConfig(key, value) {
    const data = {};
    data[key] = value;
    
    fetch('/api/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            showNotification('Konfigurationsfehler: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showNotification('Fehler beim Speichern: ' + error.message, 'error');
    });
}

// Lade aktuelle Konfiguration beim Start
function loadCurrentConfig() {
    fetch('/api/config')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const config = data.config;
                
                // Overlay-Einstellungen
                if (document.getElementById('overlay-enabled')) {
                    document.getElementById('overlay-enabled').checked = config.overlay.enabled;
                    document.getElementById('overlay-text').value = config.overlay.text_content || '';
                    document.getElementById('overlay-options').style.display = 
                        config.overlay.enabled ? 'block' : 'none';
                }
                
                // Druck-Einstellungen  
                if (document.getElementById('print-enabled')) {
                    document.getElementById('print-enabled').checked = config.printing.enabled;
                    document.getElementById('auto-print').checked = config.printing.auto_print;
                    document.getElementById('print-options').style.display = 
                        config.printing.enabled ? 'block' : 'none';
                        
                    if (config.printing.enabled) {
                        refreshPrinters();
                    }
                }
                
                // Upload-Einstellungen
                if (document.getElementById('upload-enabled')) {
                    document.getElementById('upload-enabled').checked = config.upload.enabled;
                    document.getElementById('auto-upload').checked = config.upload.auto_upload;
                    document.getElementById('upload-method').value = config.upload.upload_method;
                    document.getElementById('upload-options').style.display = 
                        config.upload.enabled ? 'block' : 'none';
                    
                    updateUploadMethod();
                }
            }
        })
        .catch(error => {
            console.error('Fehler beim Laden der Konfiguration:', error);
        });
}

// Phase 3: Kiosk & Deployment Funktionen
function toggleKioskMode() {
    const enabled = document.getElementById('kiosk-enabled').checked;
    
    fetch('/api/kiosk/toggle', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ enabled: enabled })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(enabled ? '‚úì Kiosk-Modus aktiviert' : '‚úì Kiosk-Modus deaktiviert', 'success');
        } else {
            showNotification('‚úó Fehler beim Umschalten: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Fehler: ' + error.message, 'error');
    });
}

function toggleAutostart() {
    const enabled = document.getElementById('autostart-enabled').checked;
    
    fetch('/api/autostart/toggle', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ enabled: enabled })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(enabled ? '‚úì Autostart aktiviert' : '‚úì Autostart deaktiviert', 'success');
        } else {
            showNotification('‚úó Fehler beim Umschalten: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Fehler: ' + error.message, 'error');
    });
}

function updateScreenTimeout() {
    const timeout = document.getElementById('screen-timeout').value;
    updateConfig('screen_timeout', parseInt(timeout));
    showNotification('‚úì Bildschirm-Timeout aktualisiert', 'success');
}

function toggleBackup() {
    const enabled = document.getElementById('backup-enabled').checked;
    updateConfig('backup_enabled', enabled);
    showNotification(enabled ? '‚úì Automatisches Backup aktiviert' : '‚úì Automatisches Backup deaktiviert', 'success');
}

function restartSystem() {
    if (confirm('System wirklich neustarten? Dies beendet alle laufenden Prozesse.')) {
        showLoading();
        
        fetch('/api/system/restart', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('‚úì System wird neugestartet...', 'success');
                // Nach 3 Sekunden Seite neu laden (falls Neustart fehlschl√§gt)
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } else {
                hideLoading();
                showNotification('‚úó Neustart fehlgeschlagen: ' + data.error, 'error');
            }
        })
        .catch(error => {
            hideLoading();
            showNotification('Fehler beim Neustart: ' + error.message, 'error');
        });
    }
}

function shutdownSystem() {
    if (confirm('System wirklich herunterfahren? Die Fotobox wird komplett ausgeschaltet.')) {
        showLoading();
        
        fetch('/api/system/shutdown', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('‚úì System wird heruntergefahren...', 'success');
            } else {
                hideLoading();
                showNotification('‚úó Herunterfahren fehlgeschlagen: ' + data.error, 'error');
            }
        })
        .catch(error => {
            hideLoading();
            showNotification('Fehler beim Herunterfahren: ' + error.message, 'error');
        });
    }
}

function createBackup() {
    showLoading();
    
    fetch('/api/backup/create', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showNotification('‚úì ' + data.message, 'success');
        } else {
            showNotification('‚úó Backup fehlgeschlagen: ' + data.error, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showNotification('Fehler beim Backup: ' + error.message, 'error');
    });
}

function exportConfig() {
    fetch('/api/config/export')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Download der Konfigurationsdatei
            const blob = new Blob([JSON.stringify(data.config, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = data.filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showNotification('‚úì Konfiguration exportiert', 'success');
        } else {
            showNotification('‚úó Export fehlgeschlagen: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Fehler beim Export: ' + error.message, 'error');
    });
}

function importConfig(input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const config = JSON.parse(e.target.result);
                
                fetch('/api/config/import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ config: config })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('‚úì Konfiguration importiert', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        showNotification('‚úó Import fehlgeschlagen: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    showNotification('Fehler beim Import: ' + error.message, 'error');
                });
                
            } catch (error) {
                showNotification('‚úó Ung√ºltige Konfigurationsdatei', 'error');
            }
        };
        reader.readAsText(file);
    }
}

function resetToDefaults() {
    if (confirm('Wirklich alle Einstellungen auf Standardwerte zur√ºcksetzen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
        fetch('/api/config/reset', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('‚úì Konfiguration zur√ºckgesetzt', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification('‚úó Reset fehlgeschlagen: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('Fehler beim Reset: ' + error.message, 'error');
        });
    }
}

// Speicher Info beim Laden aktualisieren
document.addEventListener('DOMContentLoaded', function() {
    checkStorage();
    loadCurrentConfig();
});
</script>

<style>
/* Phase 4 Feature Grid Styles */
.feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.feature-grid .feature-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    text-decoration: none;
    color: inherit;
    border: 2px solid #e0e0e0;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.feature-grid .feature-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border-color: #007bff;
}

.feature-grid .feature-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(135deg, #007bff, #00d4ff);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.feature-grid .feature-card:hover::before {
    opacity: 1;
}

.feature-icon {
    font-size: 3rem;
    background: linear-gradient(135deg, #007bff, #00d4ff);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    flex-shrink: 0;
}

.feature-info {
    flex: 1;
}

.feature-info h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.2rem;
    font-weight: 600;
}

.feature-info p {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
    line-height: 1.4;
}

.feature-grid .feature-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .feature-grid {
        grid-template-columns: 1fr;
    }
    
    .feature-grid .feature-card {
        padding: 1rem;
    }
    
    .feature-icon {
        font-size: 2.5rem;
    }
    
    .feature-info h3 {
        font-size: 1.1rem;
    }
}

/* Navigation Update f√ºr 4 Items */
.bottom-nav {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
}

.bottom-nav .nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.75rem 0.5rem;
    text-decoration: none;
    color: #6c757d;
    font-size: 0.8rem;
    transition: all 0.3s ease;
}

.bottom-nav .nav-item.active,
.bottom-nav .nav-item:hover {
    color: #007bff;
    background: rgba(0, 123, 255, 0.1);
}

.bottom-nav .nav-icon {
    font-size: 1.2rem;
    margin-bottom: 0.25rem;
}

@media (max-width: 480px) {
    .bottom-nav .nav-text {
        font-size: 0.7rem;
    }
    
    .bottom-nav .nav-icon {
        font-size: 1rem;
    }
}
</style>
{% endblock %}